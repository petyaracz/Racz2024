---
title: "dzsungel cikk"
author: "Rácz, Lukács"
date: "5/18/2022"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

setwd('~/Github/Racz2024')

library(tidyverse)
library(magrittr)
library(glue)
library(ggthemes)
library(broom)
library(knitr)
library(randomForest)

d = read_tsv('~/Github/Racz2024/exp_data/baseline/baseline_tidy_proc_with_corpus_and_gcm.tsv')
d = filter(d, variation == 'hotelban/hotelben')

d %<>% 
  mutate(
    final_consonant = str_extract(base_tr, '.$'),
    harmony_effect = case_when(
      final_consonant == 't' ~ 'phonetic_front',
      final_consonant %in% c('l','n') ~ 'phonological_front',
      final_consonant %in% c('r','s') ~ 'lexical_back'
    )
  )

```

Hayes et al. (2009, 2017): certain vacillating stems show a front bias when
the stem-final consonant is a

- bilabial noncontinuant: [ b p m ]
- coronal sonorant: [ n N l r ]
- sibilant: [ s z S Z ts tS dZ ]
- consonant cluster or geminate

excluded:
  
- [b] comparative adjectival suffix
- [k] plural marker
- [m], [d] POSS.1/2SG
- [S] adjectivizer

- H0: no difference between the harmonic behavior of the categories
- H1: phonological and lexical categories > baseline category
- H2: phonological and baseline categories > lexical category
- H3: phonological category > baseline and lexical categories

|stem category| stem-final consonant| harmonic bias| motivation|
  |-|-|-|-|
  |baseline | [f], [t] |(front) |(height effect)|
  |phonological | [l], [n]| front| phonological (cor son)|
  |lexical | [r], [s] |front |phonological (cor son / sib)|
  |||back| lexical (familiarity)|
  
## Final consonants in the data and the corpus

Preferences across final consonants in the data are inconclusive, don't look much like the corpus at all. 

Final consonants are not balanced across stem vowels particularly well.
  
```{r }
d %>% 
  filter(
    !is.na(harmony_effect),
    !stem_vowel %in% c('i','í')
    ) %>% 
  mutate(final_consonant = fct_relevel(final_consonant, 't','l','n','r','s')) %>% 
  ggplot(aes(final_consonant,log_odds,colour = type)) +
  geom_boxplot() +
  theme_bw() +
  scale_colour_colorblind()

d %>% 
  filter(
    !stem_vowel %in% c('i','í'),
    type == 'nonce word response',
    !is.na(harmony_effect)
    ) %>%
  mutate(final_consonant = fct_relevel(final_consonant, 't','l','n','r','s')) %>% 
  ggplot(aes(final_consonant)) +
  geom_bar() +
  theme_bw() +
  facet_wrap( ~ stem_vowel + vowel)
```

## Raw string data

We take exp data and exclude front stem vowels. We rerank final consonant so that [t] (the most frequent final consonant) is baseline level.

We fit a rf and a lm.

```{r }
d2 = d %>% 
  filter(type == 'nonce word response', !stem_vowel %in% c('i','í')) %>% 
  mutate(final_consonant = fct_relevel(final_consonant, 't'))

rf1 = randomForest(log_odds ~ stem_vowel + vowel + final_consonant, data = d2)

lm1 = lm(log_odds ~ stem_vowel + vowel + final_consonant, data = d2)

print(formula(lm1))
varImpPlot(rf1)
tidy(lm1, conf.int = T) %>% 
  select(-p.value) %>% 
  kable(digits = 2)
```

## Phonetic features

We code variables.

```{r echo = T}
# 'cs' = 'ç', 'sz' = 'ß', 'ty' = '†', 'gy' = '©', 'ny' = '¥', 'ly' = '¬'
d2 %<>% 
  mutate(
    stem_vowel_long = str_detect(stem_vowel, '[áóú]'),
    stem_vowel_open = str_detect(stem_vowel, '[aá]'),
    stem_vowel_mid = str_detect(stem_vowel, '[oó]'),
    stem_vowel_closed = str_detect(stem_vowel, '[uú]'),
    final_consonant_labial = str_detect(final_consonant, '[pmv]'),
    final_consonant_coronal = str_detect(final_consonant, '[dcsztnrlj©¥¬]'),
    final_consonant_velar = str_detect(final_consonant, '[kg]'),
    final_consonant_voiceless = str_detect(final_consonant, '[pcßt]'),
    final_consonant_voiced = str_detect(final_consonant, '[dzgv]'),
    final_consonant_obstruent = str_detect(final_consonant, '[tdpbcßszç©kg]'),
    final_consonant_sibilant = str_detect(final_consonant, '[sßz]')
  )
```

```{r }
rf2 = randomForest(log_odds ~ 
                      vowel +
                      stem_vowel_long + 
                      stem_vowel_open + 
                      stem_vowel_mid + 
                      stem_vowel_closed + 
                      final_consonant_labial + 
                      final_consonant_coronal + 
                      final_consonant_velar + 
                      final_consonant_voiceless + 
                      final_consonant_voiced + 
                      final_consonant_obstruent + 
                      final_consonant_sibilant, 
                      data = d2
)

lm2 = lm(log_odds ~ 
                      vowel +
                      stem_vowel_long + 
                      stem_vowel_open + 
                      stem_vowel_mid + 
                      # stem_vowel_closed + 
                      final_consonant_labial + 
                      final_consonant_coronal + 
                      # final_consonant_velar + 
                      final_consonant_voiceless + 
                      # final_consonant_voiced + 
                      final_consonant_obstruent + 
                      final_consonant_sibilant, 
                      data = d2
)

print(formula(lm2))
varImpPlot(rf2)
tidy(lm2, conf.int = T) %>% 
  select(-p.value) %>% 
  kable(digits = 2)
```

## Category label (baseline / lexical / phonetic, from Patay and Rácz)

```{r }
d3 = filter(d2, !is.na(harmony_effect))

rf3 = randomForest(log_odds ~ vowel + stem_vowel + harmony_effect, data = d3)
lm3 = lm(log_odds ~ vowel + stem_vowel + harmony_effect, data = d3)

print(formula(lm3))
varImpPlot(rf3)
tidy(lm3, conf.int = T) %>% 
  select(-p.value) %>% 
  kable(digits = 2)

```